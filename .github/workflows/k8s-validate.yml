name: Kubernetes Manifest Validation

on:
  push:
    branches:
      - main
    paths:
      - "manifests/**"
      - ".github/workflows/k8s-validate.yml"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  validate:
    name: Validate Kubernetes Manifests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "v1.29.0"

      - name: Restore k8s tools cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/k8s-tools
            ~/.cache/pip
          key: ${{ runner.os }}-k8s-tools-v1-${{ hashFiles('.github/workflows/k8s-validate.yml') }}
          restore-keys: |
            ${{ runner.os }}-k8s-tools-v1-
      - name: Install tools (cached)
        run: |
          set -Eeuo pipefail

          # Prepare cache directories
          mkdir -p "${HOME}/.cache/k8s-tools"
          mkdir -p "${HOME}/.cache/pip"

          # Install yamllint (pip) with cache
          pip install --cache-dir "${HOME}/.cache/pip" yamllint

          # Install kustomize with cache
          if ! command -v kustomize >/dev/null 2>&1; then
            if [ ! -f "${HOME}/.cache/k8s-tools/kustomize" ]; then
              curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
              mv kustomize "${HOME}/.cache/k8s-tools/kustomize"
            fi
            sudo cp "${HOME}/.cache/k8s-tools/kustomize" /usr/local/bin/kustomize
            sudo chmod +x /usr/local/bin/kustomize
          fi

          # Install kubesec with cache
          if ! command -v kubesec >/dev/null 2>&1; then
            if [ ! -f "${HOME}/.cache/k8s-tools/kubesec" ]; then
              wget -q https://github.com/controlplaneio/kubesec/releases/download/v2.14.1/kubesec_linux_amd64.tar.gz
              tar -xzf kubesec_linux_amd64.tar.gz
              mv kubesec "${HOME}/.cache/k8s-tools/kubesec"
              rm kubesec_linux_amd64.tar.gz
            fi
            sudo cp "${HOME}/.cache/k8s-tools/kubesec" /usr/local/bin/kubesec
            sudo chmod +x /usr/local/bin/kubesec
          fi

          # Install kubeconform
          if ! command -v kubeconform >/dev/null 2>&1; then
            curl -sL https://github.com/yannh/kubeconform/releases/download/v0.6.3/kubeconform-linux-amd64.tar.gz -o kubeconform.tar.gz
            tar -xzf kubeconform.tar.gz
            sudo mv kubeconform /usr/local/bin/
            rm kubeconform.tar.gz
          fi

      - name: YAML Lint
        run: |
          echo "=== YAML Syntax Validation ==="
          yamllint -d "{extends: default, rules: {line-length: {max: 120}, document-start: disable}}" manifests/
          echo "✓ YAML syntax valid"

      - name: Kustomize Build and Resource Check
        run: |
          echo "=== Kustomize Build Validation ==="
          cd manifests
          kustomize build . > /tmp/manifests.yaml
          echo "✓ Kustomize build successful"

          echo ""
          echo "=== Generated Resources ==="
          cat /tmp/manifests.yaml | grep -E "^(kind:|  name:)" | paste - - | head -20

          echo ""
          echo "=== Resource Count ==="
          echo "ConfigMaps: $(grep -c 'kind: ConfigMap' /tmp/manifests.yaml || echo 0)"
          echo "Secrets: $(grep -c 'kind: Secret' /tmp/manifests.yaml || echo 0)"
          echo "Deployments: $(grep -c 'kind: Deployment' /tmp/manifests.yaml || echo 0)"
          echo "Services: $(grep -c 'kind: Service' /tmp/manifests.yaml || echo 0)"
          echo "Ingresses: $(grep -c 'kind: Ingress' /tmp/manifests.yaml || echo 0)"
          echo "Databases: $(grep -c 'kind: Database' /tmp/manifests.yaml || echo 0)"

      - name: Policy Compliance Check
        run: |
          echo "=== Policy Compliance Check ==="
          cd manifests

          # Check required labels
          echo "Checking required labels..."
          REQUIRED_LABELS=("app" "component" "environment")
          for label in "${REQUIRED_LABELS[@]}"; do
            if grep -q "$label:" /tmp/manifests.yaml; then
              echo "✓ Label '$label' found"
            else
              echo "✗ Label '$label' missing"
              exit 1
            fi
          done

          # Check namespace
          echo ""
          echo "Checking namespace specification..."
          if grep -q "namespace: quarkus-crud" /tmp/manifests.yaml; then
            echo "✓ Namespace explicitly specified"
          else
            echo "✗ Namespace not specified"
            exit 1
          fi

          # Check image tag
          echo ""
          echo "Verifying image tags..."
          IMAGE_TAG=$(grep "image:" /tmp/manifests.yaml | grep -o "ghcr.io/yuki-js/quarkus-crud:.*" | head -1)
          echo "Found image tag: $IMAGE_TAG"
          if echo "$IMAGE_TAG" | grep -q "latest-native"; then
            echo "✓ Using native image tag"
          else
            echo "⚠ Not using native image tag"
          fi

      - name: Documentation Check
        run: |
          echo "=== Documentation Check ==="

          # Check application.properties
          if [ -f "manifests/application.properties" ]; then
            echo "✓ application.properties found"
          else
            echo "✗ application.properties not found"
            exit 1
          fi

          # Check kustomization.yaml structure
          echo ""
          echo "Checking kustomization.yaml structure..."
          if grep -q "configMapGenerator:" manifests/kustomization.yaml; then
            echo "✓ ConfigMap generator configured"
          else
            echo "⚠ No ConfigMap generator found"
          fi

          if grep -q "images:" manifests/kustomization.yaml; then
            echo "✓ Image management configured"
          else
            echo "⚠ No image management found"
          fi

      - name: Security Scan
        run: |
          echo "=== Security Scan ==="
          kubesec scan /tmp/manifests.yaml || echo "⚠ Security scan completed with warnings"

          echo ""
          echo "=== Best Practices Check ==="
          cd manifests

          # Check for imagePullPolicy
          if kustomize build . | grep -q "imagePullPolicy"; then
            echo "✓ imagePullPolicy specified"
          else
            echo "⚠ Consider adding imagePullPolicy"
          fi

          # Check for resource limits
          if kustomize build . | grep -A5 "resources:" | grep -q "limits:"; then
            echo "✓ Resource limits defined"
          else
            echo "⚠ Resource limits not found"
          fi

          # Check for health probes
          if kustomize build . | grep -q "livenessProbe\|readinessProbe"; then
            echo "✓ Health probes defined"
          else
            echo "⚠ Consider adding liveness and readiness probes"
          fi

          # Check for security context
          if kustomize build . | grep -q "securityContext:"; then
            echo "✓ Security context defined"
          else
            echo "⚠ Consider adding security context"
          fi

      - name: Kubeconform Schema Validation
        run: |
          echo "=== Kubeconform Validation ==="
          kubeconform -summary -strict -kubernetes-version 1.29.0 /tmp/manifests.yaml || echo "⚠ Schema validation warnings"

      - name: Start kind cluster
        if: ${{ false }}
        uses: helm/kind-action@v1
        with:
          cluster_name: validation-cluster
          wait: 30s

      - name: Kubectl Schema Validation
        if: ${{ false }}
        run: |
          echo "=== Kubectl Schema Validation ==="
          kubectl create namespace quarkus-crud

          cd manifests
          echo "Validating Deployment..."
          kubectl apply --dry-run=server -f backend.yaml || true

          echo ""
          echo "Validating Secret..."
          kubectl apply --dry-run=server -f common-secret.yaml || true

          echo ""
          echo "Validating Ingress..."
          kubectl apply --dry-run=server -f ingress.yaml || true

          echo ""
          echo "Validating all resources via Kustomize..."
          kubectl apply --dry-run=server -k . 2>&1 | tee /tmp/validation.log

          if grep -q "created (server dry run)" /tmp/validation.log; then
            echo "✓ Standard Kubernetes resources validated successfully"
          fi

          if grep -q "no matches for kind \"Database\"" /tmp/validation.log; then
            echo "⚠ Database resource requires CloudNativePG operator (expected in production)"
          fi

      - name: Summary
        if: always()
        run: |
          echo "=== Validation Summary ==="
          echo "✅ All validation checks completed successfully"

      - name: Upload validation artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k8s-validation
          path: |
            /tmp/manifests.yaml
            /tmp/validation.log
          if-no-files-found: ignore
