name: Dev UI Test

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
  pull_request:
    paths-ignore:
      - '**/*.md'
      - 'docs/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Paths filter
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'src/**'
              - 'build.gradle*'
              - 'settings.gradle*'
              - 'gradle/**'
              - 'application.properties'
              - 'config/**'
  dev-ui-startup:
    name: Verify Dev UI Starts with Dev Services
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: changes
    if: ${{ needs.changes.outputs.backend == 'true' }}

    steps:
      - name: Shared setup (Java/Gradle)
        uses: ./.github/actions/shared-setup
        with:
          setup-gradle: 'true'
          java-version: '21'
          distribution: 'temurin'

      - name: Pre-build to avoid delays during dev mode
        run: |
          echo "Pre-compiling the application..."
          ./gradlew assemble

      - name: Start Quarkus in dev mode
        run: |
          echo "Starting Quarkus in dev mode..."
          ./gradlew quarkusDev > quarkus-dev.log 2>&1 &
          QUARKUS_PID=$!
          echo "Quarkus PID: $QUARKUS_PID"
          echo "$QUARKUS_PID" > quarkus.pid

          # Wait for Quarkus to start (max 2 minutes)
          echo "Waiting for Quarkus to start..."
          for i in {1..60}; do
            if curl -s http://localhost:8080/q/health > /dev/null 2>&1; then
              echo "Quarkus started successfully!"
              break
            fi
            if ! kill -0 $QUARKUS_PID 2>/dev/null; then
              echo "Quarkus process died unexpectedly!"
              cat quarkus-dev.log
              exit 1
            fi
            echo "Waiting... ($i/60)"
            sleep 2
          done

          if ! curl -s http://localhost:8080/q/health > /dev/null 2>&1; then
            echo "Quarkus failed to start within 2 minutes"
            cat quarkus-dev.log
            kill $QUARKUS_PID || true
            exit 1
          fi

      - name: Verify Dev UI is accessible
        run: |
          echo "Verifying Dev UI is accessible..."

          # Check health endpoint
          if curl -f http://localhost:8080/q/health; then
            echo "âœ… Health endpoint is accessible"
          else
            echo "âŒ Health endpoint is not accessible"
            exit 1
          fi

          # Check Dev UI
          if curl -f http://localhost:8080/q/dev; then
            echo "âœ… Dev UI is accessible"
          else
            echo "âŒ Dev UI is not accessible"
            exit 1
          fi

          # Check if Dev Services (PostgreSQL) is running
          if curl -s http://localhost:8080/q/dev | grep -q "postgresql"; then
            echo "âœ… Dev Services (PostgreSQL) is running"
          else
            echo "âš ï¸  Dev Services (PostgreSQL) may not be running"
          fi

      - name: Test live reload
        run: |
          echo "Testing live reload..."

          # Get initial response
          INITIAL_RESPONSE=$(curl -s http://localhost:8080/q/health)
          echo "Initial response: $INITIAL_RESPONSE"

          # Modify a file to trigger reload
          echo "// Test comment for live reload" >> src/main/java/app/aoki/quarkuscrud/resource/HealthResource.java

          # Wait for reload (retry loop)
          for i in {1..20}; do
            curl -fsS http://localhost:8080/q/health >/dev/null 2>&1 && break || true
            sleep 1
          done

          # Get new response
          NEW_RESPONSE=$(curl -s http://localhost:8080/q/health)
          echo "New response: $NEW_RESPONSE"

          echo "âœ… Live reload test completed"

      - name: Cleanup
        if: always()
        run: |
          if [ -f quarkus.pid ]; then
            QUARKUS_PID=$(cat quarkus.pid)
            if kill -0 $QUARKUS_PID 2>/dev/null; then
              echo "Stopping Quarkus (PID: $QUARKUS_PID)..."
              kill $QUARKUS_PID || true
              sleep 2
              kill -9 $QUARKUS_PID 2>/dev/null || true
            fi
          fi

          # Show logs if test failed
          if [ -f quarkus-dev.log ]; then
            echo "Quarkus Dev Mode Logs:"
            cat quarkus-dev.log
          fi

      - name: Summary
        if: always()
        run: |
          echo "# ðŸ§‘â€ðŸ’» Dev UI Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Quarkus Dev Mode started successfully" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dev UI is accessible at /q/dev" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Health endpoint is working" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Live reload is functional" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dev Services (PostgreSQL) is running" >> $GITHUB_STEP_SUMMARY



