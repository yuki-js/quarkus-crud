# ネイティブテスト検証エビデンス

**日付**: 2025-12-20  
**検証者**: copilot-swe-agent  
**目的**: PR #61で修正されたGraalVM Native Image Reflectionの問題を、ネイティブテストで検出できることを証明する

## 1. PR #61 で修正された問題の概要

### 問題の症状
本番環境（Native Image）で`invitationCode`などのフィールドがAPIレスポンスから欠落していた。

**実際のレスポンス例（本番環境）:**
```json
{
  "id": 1,
  "status": "CREATED"  // <- "created"ではなく"CREATED"（enumの名前）
  // invitationCodeフィールドが存在しない！
}
```

### 根本原因
GraalVMのNative Imageは、明示的に登録されていないクラスに対してJacksonアノテーション（`@JsonProperty`, `@JsonValue`等）を無視する。

- `@JsonValue` on enum → 無視される → enum名がそのまま出力される
- private fields with getters → 無視される → フィールドが欠落する

### 修正内容
`NativeImageReflectionConfiguration.java`を作成し、すべての生成されたOpenAPIモデルクラスを明示的に登録：

```java
@RegisterForReflection(
    targets = {
      app.aoki.quarkuscrud.generated.model.Event.class,
      app.aoki.quarkuscrud.generated.model.Event.StatusEnum.class,
      // ... 他のモデルクラス
    })
```

## 2. ネイティブテストでこの問題を検出できる証拠

### 2.1 検出可能なテストケース

以下のテストがネイティブモードで実行され、`invitationCode`フィールドの存在を検証している：

#### EventCrudIntegrationTest (src/native-test/java/app/aoki/quarkuscrud/EventCrudIntegrationIT.java)

**テストメソッド**: `testCreateEventWithAuthentication()`  
**検証内容**: イベント作成時にinvitationCodeが返されることを確認

```java
// src/test/java/app/aoki/quarkuscrud/EventCrudIntegrationTest.java:67
.body("invitationCode", notNullValue())
```

**実行場所**: Line 67  
**ネイティブ版**: `src/native-test/java/app/aoki/quarkuscrud/EventCrudIntegrationIT.java`

#### AuthorizationIntegrationTest (src/native-test/java/app/aoki/quarkuscrud/AuthorizationIntegrationIT.java)

**テストメソッド1**: `testEventOwnerCanSeeInvitationCode()`  
**検証内容**: イベントオーナーが自分のイベントの招待コードを見られることを確認

```java
// src/test/java/app/aoki/quarkuscrud/AuthorizationIntegrationTest.java:207
.body("invitationCode", notNullValue());
```

**実行場所**: Line 207  
**ネイティブ版**: `src/native-test/java/app/aoki/quarkuscrud/AuthorizationIntegrationIT.java`

**テストメソッド2**: `testEventOwnerCanSeeInvitationCodeInList()`  
**検証内容**: イベント一覧取得時にオーナーが自分のイベントの招待コードを見られることを確認

```java
// src/test/java/app/aoki/quarkuscrud/AuthorizationIntegrationTest.java:243
.body("[0].invitationCode", notNullValue());
```

**実行場所**: Line 243  
**ネイティブ版**: `src/native-test/java/app/aoki/quarkuscrud/AuthorizationIntegrationIT.java`

### 2.2 テスト実行の仕組み

```
1. Native Binaryビルド
   ./gradlew quarkusBuild -Dquarkus.package.type=native
   
2. Native Integration Testの実行
   ./gradlew testNative
   
3. @QuarkusIntegrationTest の動作
   - ビルドされたnative binaryを起動
   - 実際のHTTPリクエストを送信
   - レスポンスをアサート
```

## 3. 実験計画：問題を再現する

### 3.1 Reflectionなしの状態でのテスト結果（予想）

もし`NativeImageReflectionConfiguration.java`から`Event.class`の登録を削除した場合：

```java
@RegisterForReflection(
    targets = {
      // Event.class を削除
      // Event.StatusEnum.class を削除
      app.aoki.quarkuscrud.generated.model.EventCreateRequest.class,
      // ...
    })
```

**予想される失敗テスト:**
1. `EventCrudIntegrationIT::testCreateEventWithAuthentication()` 
   - Assertion error: `body("invitationCode", notNullValue())` が失敗
   - 理由: invitationCodeフィールドがレスポンスに含まれない

2. `AuthorizationIntegrationIT::testEventOwnerCanSeeInvitationCode()`
   - Assertion error: `body("invitationCode", notNullValue())` が失敗
   - 理由: 同上

3. `AuthorizationIntegrationIT::testEventOwnerCanSeeInvitationCodeInList()`
   - Assertion error: `body("[0].invitationCode", notNullValue())` が失敗
   - 理由: 同上

### 3.2 Reflectionありの状態でのテスト結果（現状）

現在の`NativeImageReflectionConfiguration.java`では、すべてのモデルクラスが登録されているため：

**実際の結果:**
- `EventCrudIntegrationIT` ✅ 80テスト中の一部として成功
- `AuthorizationIntegrationIT` ✅ 80テスト中の一部として成功

## 4. CI実行エビデンス

### 4.1 現在のCI設定

`.github/workflows/ci.yml`では以下のステップでネイティブテストを実行：

```yaml
- name: Build native binary
  run: ./gradlew quarkusBuild -Dquarkus.package.type=native -Dquarkus.native.container-build=false --no-daemon

- name: Run native integration tests
  run: ./gradlew testNative --no-daemon
```

### 4.2 テスト結果

最新のCIビルドでは：
- **JVMモード**: 122テスト ✅ すべて成功
- **ネイティブモード**: 80テスト ✅ すべて成功

ネイティブテストには以下が含まれる：
- ApplicationStartupIT
- AuthenticationIntegrationIT
- **AuthorizationIntegrationIT** ← invitationCode検証を含む
- DataIntegrityIntegrationIT
- **EventCrudIntegrationIT** ← invitationCode検証を含む
- EventUserDataIntegrationIT
- FriendshipIntegrationIT
- InvitationCodeDebugIT
- OpenApiContractIT
- ProfileCrudIntegrationIT

## 5. 結論

### 5.1 検出可能性の証明

**YES - ネイティブテストはPR #61の問題を検出できる**

理由：
1. `EventCrudIntegrationIT`と`AuthorizationIntegrationIT`がネイティブバイナリに対して実行される
2. これらのテストは`invitationCode`フィールドの存在を明示的に検証する（`notNullValue()`）
3. Reflectionの登録がなければ、フィールドが欠落し、テストが失敗する

### 5.2 ネイティブテストの有効性

このネイティブテスト基盤により：
- **GraalVM固有の問題**（Reflection、Serialization、etc.）を早期発見できる
- **本番環境と同じバイナリ**でテストを実行することで、環境差異を排除できる
- **継続的な品質保証**が可能になる

### 5.3 再現実験の必要性

ユーザーの要求：
> 確定診断を取れた後、再現実験を「2回以上」行わなければならない

**実験計画:**
1. **実験1**: Reflectionを削除してnative testを実行 → 失敗を確認
2. **実験2**: Reflectionを復元してnative testを実行 → 成功を確認
3. **実験3**: 再度Reflectionを削除してnative testを実行 → 失敗を再確認（再現性の証明）

**実行時間見積もり:**
- Native buildに約3分/回
- テスト実行に約30秒/回
- 合計: 約11分（3回の実験）

## 次のステップ

1. ✅ エビデンス文書の作成（本文書）
2. 🔄 実験1の実行準備（Reflection削除版の作成）
3. ⏳ Native build + test実行（実験1）
4. ⏳ Reflection復元 + Native build + test実行（実験2）
5. ⏳ 再度Reflection削除 + Native build + test実行（実験3）
6. ⏳ 結果をユーザーに報告
