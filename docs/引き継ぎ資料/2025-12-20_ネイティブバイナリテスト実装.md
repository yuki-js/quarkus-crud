# ネイティブバイナリテストの実装

**日付**: 2025-12-20  
**担当**: copilot-swe-agent  
**Issue**: #[番号] - Nativeバイナリでテストを回す

## 概要

このドキュメントは、Quarkus アプリケーションでネイティブバイナリテストを実装した際の作業内容と、今後のメンテナンスのための重要情報をまとめたものです。

## 実装内容

### 1. ネイティブテストの構造

Quarkusの推奨パターンに従い、以下の構造でネイティブテストを実装しました:

- **JVMモードテスト** (`src/test/java`): 通常の`@QuarkusTest`を使用した122件のテスト
- **ネイティブモードテスト** (`src/native-test/java`): `@QuarkusIntegrationTest`を使用した80件の統合テスト

### 2. テストの分類

#### JVMモード (src/test/java)
- ユニットテスト (service, entityパッケージ)
- `@QuarkusTest`を使用した統合テスト
- モック（`@InjectMock`）を利用可能

#### ネイティブモード (src/native-test/java)
以下のテストクラスがネイティブバイナリに対して実行されます:

- `ApplicationStartupIT` - アプリケーション起動確認
- `AuthenticationIntegrationIT` - 認証フロー
- `AuthorizationIntegrationIT` - 認可フロー
- `DataIntegrityIntegrationIT` - データ整合性
- `EventCrudIntegrationIT` - イベントCRUD
- `EventUserDataIntegrationIT` - イベントユーザーデータ
- `FriendshipIntegrationIT` - フレンドシップ機能
- `InvitationCodeDebugIT` - 招待コードデバッグ
- `OpenApiContractIT` - OpenAPI契約テスト
- `ProfileCrudIntegrationIT` - プロフィールCRUD

**重要**: サービスレイヤーのユニットテスト(EventServiceIT, FriendshipServiceIT, ProfileServiceIT, UserServiceIT)は、`@InjectMock`に依存するため、ネイティブテストには含まれません。

### 3. ビルドとテストのコマンド

#### ローカル環境

```bash
# JVMモードのテスト（通常のテスト）
./gradlew test

# ネイティブバイナリのビルド
./gradlew quarkusBuild -Dquarkus.package.type=native -Dquarkus.native.container-build=false

# ネイティブテストの実行
./gradlew testNative
```

#### CI環境

CI (`.github/workflows/ci.yml`) では以下の順序で実行されます:

1. JVMモードでのビルドとテスト
2. GraalVMのセットアップ
3. ネイティブバイナリのビルド（約3分）
4. ネイティブテストの実行

### 4. 重要な設定

#### build.gradle

```gradle
test {
    systemProperty "java.util.logging.manager", "org.jboss.logmanager.LogManager"
    // *IT.class は除外（src/native-test/javaに移動済み）
}

tasks.named('testNative') {
    systemProperty "java.util.logging.manager", "org.jboss.logmanager.LogManager"
}
```

#### .github/workflows/ci.yml

- GraalVM 21を使用
- `graalvm/setup-graalvm@v1`アクションでGraalVMをセットアップ
- PostgreSQL 15-alpineをサービスコンテナとして起動
- JVMテストとネイティブテストの両方の結果を集計

## テスト実行時間

- **JVMモードテスト**: 約45秒
- **ネイティブビルド**: 約3分
- **ネイティブテスト**: 約30秒
- **合計CI時間**: 約5-6分

## トラブルシューティング

### ネイティブテストが "NO-SOURCE" になる

原因: テストファイルが`src/native-test/java`ではなく`src/test/java`にある

解決策: テストを正しいディレクトリに配置する

### サービステストがネイティブで失敗する

原因: `@InjectMock`は`@QuarkusIntegrationTest`では使用できない

解決策: モックを使用するユニットテストはJVMモードのみで実行する（`src/test/java`に配置）

### ネイティブビルドがメモリ不足で失敗する

解決策: 
- Gradle設定で`-Xmx`を増やす
- GraalVMのメモリ設定を調整する
- コンテナビルド(`-Dquarkus.native.container-build=true`)を検討する

## 今後の拡張

### 新しいネイティブテストを追加する場合

1. `src/native-test/java`に`*IT.java`という命名規則でテストクラスを作成
2. `@QuarkusIntegrationTest`アノテーションを付与
3. 既存の`@QuarkusTest`クラスを継承することで、同じテストをネイティブでも実行可能

例:
```java
package app.aoki.quarkuscrud;

import io.quarkus.test.junit.QuarkusIntegrationTest;

@QuarkusIntegrationTest
public class NewFeatureIT extends NewFeatureTest {
  // 既存のテストがネイティブバイナリに対して実行される
}
```

### モックを使用しないテストの場合

完全な統合テストとして`src/native-test/java`に直接実装することも可能です。

## 参考資料

- [Quarkus Native Testing Guide](https://quarkus.io/guides/building-native-image)
- [GraalVM Native Image](https://www.graalvm.org/latest/reference-manual/native-image/)
- プロジェクトの`build.gradle`
- `.github/workflows/ci.yml`

## 変更履歴

- 2025-12-20: 初版作成 - ネイティブテスト基盤の実装完了
