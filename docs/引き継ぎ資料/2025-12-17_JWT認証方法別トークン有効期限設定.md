# JWT認証方法別トークン有効期限設定

**日付**: 2025-12-17  
**担当者**: GitHub Copilot Agent  
**課題**: 匿名ユーザーとOIDCユーザーで異なるJWTトークン有効期限を設定

## 概要

JwtServiceにおいて、すべてのユーザー種別のトークンが一律の有効期限（86400秒 = 24時間）となっていた問題を解決しました。
匿名ユーザーは外部認証による再認証ができないため、より長い有効期限が必要です。一方、OIDCユーザーはOAuth2のベストプラクティスに従い、短い有効期限を設定すべきです。

## 実装内容

### 1. JwtService.java の変更

**変更前:**
```java
@ConfigProperty(name = "smallrye.jwt.new-token.lifespan")
Long tokenLifespan;
```

**変更後:**
```java
@ConfigProperty(name = "smallrye.jwt.new-token.lifespan.anonymous")
Long anonymousTokenLifespan;

@ConfigProperty(name = "smallrye.jwt.new-token.lifespan.oidc")
Long oidcTokenLifespan;
```

### 2. 有効期限選択ロジックの追加

認証方法に基づいて適切な有効期限を選択する新しいprivateメソッド `getTokenLifespan()` を追加しました：

```java
private Long getTokenLifespan(AuthMethod authMethod) {
  return switch (authMethod) {
    case ANONYMOUS -> anonymousTokenLifespan;
    case OIDC -> oidcTokenLifespan;
  };
}
```

### 3. プロパティ設定の更新

**application.properties** および **test resources/application.properties**:

```properties
# Token lifespan configuration by authentication method
# Anonymous users: 365 days (31536000 seconds) - longer since they cannot re-authenticate
smallrye.jwt.new-token.lifespan.anonymous=31536000
# OIDC users: 1 hour (3600 seconds) - follows OAuth2 best practices for short-lived tokens
smallrye.jwt.new-token.lifespan.oidc=3600
```

### 4. Kubernetesマニフェストの更新

**manifests/backend.yaml** に環境変数を追加：

```yaml
env:
  # JWT token lifespan configuration
  - name: SMALLRYE_JWT_NEW_TOKEN_LIFESPAN_ANONYMOUS
    value: "31536000"  # 365 days for anonymous users
  - name: SMALLRYE_JWT_NEW_TOKEN_LIFESPAN_OIDC
    value: "3600"  # 1 hour for OIDC users
```

## 設定値の根拠

### 匿名ユーザー: 365日間 (31,536,000秒)
- **理由**: 匿名ユーザーは外部認証ができないため、トークンの有効期限が切れるとユーザーアイデンティティを失う
- **影響**: より長い有効期限により、ユーザー体験が向上
- **セキュリティ**: 匿名ユーザーは限定的な権限のみを持つため、長期トークンのリスクは低い

### OIDCユーザー: 1時間 (3,600秒)
- **理由**: OAuth2/OpenID Connectのベストプラクティスに従う
- **影響**: 短い有効期限により、漏洩時のリスクを最小化
- **利便性**: OIDCユーザーは外部プロバイダーで再認証可能なため、短い有効期限でも問題なし

## テスト結果

すべてのCI相当のチェックが成功しました：

### ビルドとテスト
```bash
./gradlew build spotlessCheck checkstyleMain checkstyleTest --no-daemon
# 結果: BUILD SUCCESSFUL
# テスト: 120個すべて合格
```

### コード品質チェック
- **Spotless**: 合格
- **Checkstyle (main)**: 合格
- **Checkstyle (test)**: 合格

### OpenAPI検証
```bash
spectral lint build/openapi-compiled/openapi.yaml --ruleset .spectral.yaml
# 結果: 1 warning (license情報の欠如、既存の問題)

java -jar openapi-generator-cli.jar validate -i build/openapi-compiled/openapi.yaml
# 結果: No validation issues detected
```

## 後方互換性

この変更は後方互換性を維持します：
- 既存の認証フローに変更なし
- 既存のAPIエンドポイントに変更なし
- データベーススキーマに変更なし
- プロパティ名のみ変更（新しいプロパティキーを使用）

## 今後の考慮事項

### 環境変数による上書き
本番環境では、環境変数を通じてこれらの値を上書き可能です：
```bash
SMALLRYE_JWT_NEW_TOKEN_LIFESPAN_ANONYMOUS=31536000
SMALLRYE_JWT_NEW_TOKEN_LIFESPAN_OIDC=3600
```

Kubernetesマニフェストでは、これらの環境変数がDeploymentに設定されています。

### リフレッシュトークンの検討
将来的には、より短い有効期限のアクセストークンとリフレッシュトークンの組み合わせを検討することを推奨します。

### トークンローテーション
セキュリティをさらに強化するために、定期的なトークンローテーションの実装を検討してください。

## 関連ファイル

### 変更されたファイル
- `src/main/java/app/aoki/quarkuscrud/service/JwtService.java`
- `src/main/resources/application.properties`
- `src/test/resources/application.properties`
- `manifests/backend.yaml` (Kubernetes Deployment環境変数)

### 関連ファイル（変更なし）
- `src/main/java/app/aoki/quarkuscrud/entity/AuthMethod.java` - 認証方法のenumの定義
- `src/main/java/app/aoki/quarkuscrud/entity/AuthnProvider.java` - 認証プロバイダーのエンティティ
- `src/main/java/app/aoki/quarkuscrud/resource/AuthenticationApiImpl.java` - JwtServiceを使用するAPI実装
- `src/test/java/app/aoki/quarkuscrud/AuthenticationIntegrationTest.java` - 認証の統合テスト

## 追加情報

### Java バージョン
- 使用: Java 21 (OpenJDK Temurin 21.0.9+10-LTS)
- CI環境と同等

### CI ワークフロー
`.github/workflows/ci.yml` に定義されているすべてのチェックを通過：
1. OpenAPI Specification Validation
2. Build and Test（PostgreSQL 15との統合テスト含む）

## まとめ

この実装により、匿名ユーザーは365日間のトークン有効期限でユーザーアイデンティティを保持でき、OIDCユーザーは1時間のセキュアな有効期限で運用されます。すべてのテストとコード品質チェックが合格し、CI環境での動作を保証します。Kubernetesデプロイメントでも環境変数を通じて同じ設定が適用されます。
